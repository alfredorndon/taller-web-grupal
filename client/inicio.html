<!DOCTYPE html>
<html lang="es-VE">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta author="Jharold Panza, Oscar Manrique, Alfredo Rond√≥n " />
    <meta name="description" content="Este es un juego de Batalla Naval" />
    <meta name="keywords" content="Batalla Naval, juego, taller, semestre" />
    <meta name="robots" content="index,follow" />
    <title>Batalla Naval | Inicio</title>
    <link rel="icon" href="https://seguropordias.com/img/contenido/barco-famoso-titanic.jpg" type="image/png"
        size="16x16 32x32 64x64" />
    <link rel="stylesheet" href="styles/styles.css" type="text/css" />
    <script src="script/script.js" type="text/javascript"></script>
</head>

<body>
    <div class="main-container" id="container-inicio">
        <header>
            <div id="titulo-principal">
                <h1>Batalla Naval</h1>
            </div>
            <nav class="nav-primaria">
                <ul>
                    <li><a href="#jugar-section">Jugar</a></li>
                    <li><a href="#inicio">¬øQu√© es "Batalla Naval"?</a></li>
                    <li><a href="#instrucciones-section">Instrucciones</a></li>
                </ul>
            </nav>
        </header>
        <main>

            <section id="jugar-section">
                <h2>Jugar</h2>
                <form action="#" method="post" id="datos-del-jugador-frm">
                    <label for="datos-del-jugador-frm-nombre">Nombre</label>
                    <input id="datos-del-jugador-frm-nombre" name="nombre" placeholder="Nombre" />
                    <button id="nombre-jugador" type="button">Confirmar</button>
                </form>
                <br />
                <h3>Modos de Juego</h3>
                <ul>
                    <li><a id="2-jugadores">2 Jugadores</a></li>
                    <li><a id="3-jugadores">3 Jugadores</a></li>
                    <li><a id="4-jugadores">4 Jugadores</a> </li>
                    <li><a id="torneo">Torneo</a></li>
                </ul>
            </section>

            <section id="que-es-section">
                <h2>¬øQu√© es "Batalla Naval"?</h2>
                <p>
                    Batalla naval es un juego por turnos d√≥nde el objetivo es hundir la flota del enemigo tratando de
                    adivinar la ubicaci√≥n de los barcos hostiles dentro de un tablero con coordenadas preestablecidas. 
                    ¬°S√© m√°s r√°pido que tus contrincantes y alcanza la victoria en medio del oc√©ano!
                </p>
            </section>

            <section id="instrucciones-section">
                <h2>Instrucciones</h2>
                <nav class="nav-secundaria">
                    <ul>
                        <li><a href="#objetivo">Objetivo</a></li>
                        <li><a href="#componente">Componentes</a></li>
                        <li><a href="#preparacion-inst">Preparaci√≥n</a></li>
                        <li><a href="#turno">Turnos</a></li>
                        <li><a href="#impacto">Impactos</a></li>
                        <li><a href="#hundimiento">Hundimiento</a></li>
                        <li><a href="#victoria">Victoria</a></li>
                        <li><a href="#duracion-turno">Duraci√≥n del turno</a></li>
                    </ul>
                </nav>
                <h3 id="objetivo">Objetivo</h3>
                <p>Hundir toda la flota enemiga antes que tu oponente hunda la tuya.</p>
                <h3 id="componente">Componentes</h3>
                <p>Tablero de juego para cada jugador (10x10 cuadr√≠culas). Flota de barcos:
                <ul>
                    <li>1 portaaviones (abarca 5 casillas, ya sea en sentido horizontal o vertical)</li>
                    <li>1 acorazado (4 casillas, ya sea en sentido horizontal o vertical)</li>
                    <li>1 crucero (3 casillas, ya sea en sentido horizontal o vertical)</li>
                    <li>1 submarino (3 casillas, ya sea en sentido horizontal o vertical)</li>
                    <li>1 destructor (2 casillas, ya sea en sentido horizontal o vertical)</li>
                </ul>
                </p>
                <h3 id="preparacion-inst">Preparaci√≥n</h3>
                <p>Cada jugador coloca sus barcos en el tablero de manera oculta al oponente.
                    Los barcos pueden colocarse vertical u horizontalmente.
                    Los barcos no pueden superponerse.</p>
                <h3 id="turno">Turnos</h3>
                <p>Los jugadores se turnan para "disparar" a las casillas del oponente, intentando adivinar la posici√≥n
                    de los barcos enemigos.
                    Cada disparo se indica seleccionando una casilla en el tablero del oponente.
                    El jugador a quien le corresponder√° "disparar" por primera vez (primer turno) ser√° seleccionado al
                    azar.</p>
                <h3 id="impacto">Impactos</h3>
                <p>Si un jugador acierta un disparo en una casilla que contiene parte de un barco enemigo, se marca un
                    "impacto" (hit).
                    Si el disparo no acierta en ning√∫n barco, se marca un "fallo" (miss).</p>
                <h3 id="hundimiento">Hundimiento</h3>
                <p>Cuando todas las casillas de un barco han sido impactadas, el barco se considera "hundido".
                    Se debe informar al oponente qu√© barco ha sido hundido.</p>
                <h3 id="victoria">Victoria</h3>
                <p>El primer jugador en hundir toda la flota enemiga gana la partida.</p>
                <h3 id="duracion-turno">Duraci√≥n del turno</h3>
                <p>Los jugadores tienen un (1) minuto para aprovechar su turno.
                    Si un jugador no realiza su movimiento dentro del l√≠mite de tiempo, se considera un turno perdido.
                </p>
            </section>


        </main>
    </div>

    <div class="main-container" id="container-tablero-barcos">
        <header>
            <div id="crea-tu-tablero">
                <h1>Crea tu Tablero</h1>
            </div>
        </header>
        <main>
            <section id="tableros-barcos">
                <div id="tableros-creacion"></div>
                
                <section id="preparacion">
                    <h2>Sus barcos disponibles</h2>

                    <select id="selector-barco">
                        <option value="portaaviones">Portaaviones</option>
                        <option value="acorazado">Acorazado</option>
                        <option value="crucero">Crucero</option>
                        <option value="submarino">Submarino</option>
                        <option value="destructor">Destructor</option>
                    </select>
                    
                    <select id="selector-orientacion">
                        <option value="horizontal">Horizontal</option>
                        <option value="vertical">Vertical</option>
                    </select>

                    <ul id="lista-barcos">
                        <li>1 Portaaviones (5 casillas)</li>
                        <li>1 Acorazado (4 casillas)</li>
                        <li>1 Crucero (3 casillas)</li>
                        <li>1 Submarino (3 casillas)</li>
                        <li>1 Destructor (2 casillas)</li>
                        <br>
                        <li>Para poder unirte o crear una partida</li>
                        <li>debes colocar todos los barcos en el tablero.</li>
                    </ul>
                    <button id="union-game">Unirme a un juego</button>
                    <button id="creacion-game">Crear un juego</button>
                </section>
            </section>
            <section id="volver-inicio">
                <h2>Volver al Inicio</h2>
                <p id="boton-volver">Volver</p>
            </section>
        </main>
    </div>

    <div class="main-container" id="container-juego">
        <header>
            <div id="modo-juego"><h1>Partida de </h1></div>
            <h2 id="encabezado-enemigo"> Tus enemigos son: </h2>
            <div id="anuncio">
                <h3>anuncio</h3>
            </div>
        </header>
        <main>
            <section id="tableros">
            </section>
            <section id="boosters">
                <h2>Potenciadores</h2>
                <p id="puntaje">Tienes 0 puntos</p>
                <ul>
                    <li id="sonar">Sonar üîä - 15 puntos</li>
                    <li id="mina-marina">Mina Marina üí£ - 10 puntos</li>
                    <li id="pem">Ataque PEM üîå - 25 puntos</li>
                </ul>
                <button id="compra-potenciador">Comprar</button>
            </section>
            <section class="salir-del-juego">
                <h2>Salir del juego</h2>
                <a id="boton-salir">Salir</a>
            </section>
        </main>
    </div>

    <div class="main-container" id="container-lobby">
        <header>
            <div>
                <h2 id="titulo-lobby">Lobby</h2>
                <h2 id="titulo-leaderboard">Leaderboard</h2>
            </div>
            <h2 id="etapa">Octavos</h2>
        </header>
        <main>
            <section id="interfaz">
                <table id="tabla-torneo">
                    <thead>
                        <tr>
                            <th>Jugadores</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td id="jugador1"></td>
                        </tr>
                        <tr>
                            <td id="jugador2"></td>
                        </tr>
                        <tr>
                            <td id="jugador3"></td>
                        </tr>
                        <tr>
                            <td id="jugador4"></td>
                        </tr>
                        <tr>
                            <td id="jugador5"></td>
                        </tr>
                        <tr>
                            <td id="jugador6"></td>
                        </tr>
                        <tr>
                            <td id="jugador7"></td>
                        </tr>
                        <tr>
                            <td id="jugador8"></td>
                        </tr>
                    </tbody>
                </table>
                <div id="espacio-vacio"></div>
                <button type="button" id="listo">Iniciar Partida</button>
                <p id="restantes">(0) restantes</p>
            </section>
            <section class="salir-del-juego">
                <h2>Salir del juego</h2>
                <a id="boton-salir-lobby">Salir</a>
            </section>
        </main>
    </div>

    <script>
        const ws = new WebSocket('ws://taller-web-grupal-production.up.railway.app');
        const cantidadJug2 = document.getElementById('2-jugadores');
        const cantidadJug3 = document.getElementById('3-jugadores');
        const cantidadJug4 = document.getElementById('4-jugadores');
        const nombreJug = document.getElementById('nombre-jugador');
        ocultarSeccion('container-juego');
        ocultarSeccion('container-lobby');
        ocultarSeccion('container-tablero-barcos');

        let confirmacionNombre = false;

        cantidadJug2.addEventListener('click', function (event) {
            if (!confirmacionNombre) {
                alert('Por favor, confirme su nombre para jugar');
                event.preventDefault();
            }
            else {
                localStorage.setItem('cantidadJugadores', '2');
                cargarNuevaSeccion('container-tablero-barcos', 'container-inicio', localStorage.getItem('cantidadJugadores'));
            }
        });
        cantidadJug3.addEventListener('click', function (event) {
            if (!confirmacionNombre) {
                alert('Por favor, confirme su nombre para jugar');
                event.preventDefault();
            }
            else {
                localStorage.setItem('cantidadJugadores', '3');
                cargarNuevaSeccion('container-tablero-barcos', 'container-inicio', localStorage.getItem('cantidadJugadores'));
            }
        });
        cantidadJug4.addEventListener('click', function (event) {
            if (!confirmacionNombre) {
                alert('Por favor, confirme su nombre para jugar');
                event.preventDefault();
            }
            else {
                localStorage.setItem('cantidadJugadores', '4');
                cargarNuevaSeccion('container-tablero-barcos', 'container-inicio', localStorage.getItem('cantidadJugadores'));
            }
        });
        nombreJug.addEventListener('click', function (event) {
            const nombre = document.getElementById('datos-del-jugador-frm-nombre');
            const nombreSinEspacios = nombre.value.trim();
            if (nombreSinEspacios === '') {
                alert('Por favor, ingrese su nombre para jugar');
                event.preventDefault();
            }
            else {
                localStorage.setItem('nombreJugador', nombreSinEspacios);
                confirmacionNombre = true;
                alert('su nombre ha sido confirmado: ' + nombreSinEspacios);
            }
        });
        document.getElementById('torneo').addEventListener('click', function (event) {
            if (!confirmacionNombre) {
                alert('Por favor, confirme su nombre para jugar');
                event.preventDefault();
            }
            else {
                localStorage.setItem('cantidadJugadores', '8');
                cargarNuevaSeccion('container-tablero-barcos', 'container-inicio', localStorage.getItem('cantidadJugadores'));
            }
        })

        ws.addEventListener('open', () => {
            console.log('Conectado al servidor ' + ws);
        })

        ws.addEventListener('close', () => {
            console.log('desconectado del servidor');
        })

        ws.addEventListener('message', (event) => {
            try {
                const mensaje = JSON.parse(event.data);
                switch (mensaje.type) {
                    case 'gameCreated': {
                        localStorage.setItem('partidaActiva', mensaje.gameId);
                        const gamePlayers = mensaje.players.map(player => player.name);
                        alterarLobby(localStorage.getItem('cantidadJugadores'), localStorage.getItem('partidaActiva'), gamePlayers);
                        cargarNuevaSeccion('container-lobby', 'container-tablero-barcos', localStorage.getItem('cantidadJugadores'));
                    }
                        break;
                    case 'playerJoined': {
                        console.log('HOLA!: ' + mensaje.name + ' te has unido a un juego exitosamente');
                        localStorage.setItem('partidaActiva', mensaje.gameId);
                        alterarLobby(localStorage.getItem('cantidadJugadores'), localStorage.getItem('partidaActiva'), mensaje.gamePlayers);
                        cargarNuevaSeccion('container-lobby', 'container-tablero-barcos', localStorage.getItem('cantidadJugadores'));
                    }
                        break;
                    case 'gameStarted': {
                        console.log('se ha iniciado el juego');
                        cargarNuevaSeccion('container-juego', 'container-lobby', localStorage.getItem('cantidadJugadores'), mensaje.gamePlayers);
                        modificarAnuncio("Ahora es el turno de "+mensaje.gamePlayers[mensaje.turno]);
                        recopilarEnemigos();
                        asignarClicks(mensaje.gamePlayers, mensaje.turno);
                    }
                        break;
                    case 'error': {
                        alert(mensaje.message);
                        event.preventDefault();
                    }
                        break;
                    case 'getPlayers': {
                        console.log(mensaje.gamePlayers);
                        alterarLobby(localStorage.getItem('cantidadJugadores'), localStorage.getItem('partidaActiva'), mensaje.gamePlayers);
                    }
                        break;
                    case 'playerLeft-party': {
                        eliminarTablas(mensaje.name);
                        alert('El jugador ' + mensaje.name + ' ha abandonado la partida.');
                        recopilarEnemigos();
                        modificarEnemigos(mensaje.gamePlayers);
                        modificarAnuncio("Ahora es el turno de "+mensaje.gamePlayers[mensaje.turno]);
                        asignarClicks(mensaje.gamePlayers, mensaje.turno);
                    }
                        break;
                    case 'playerLeft-lobby': {
                        console.log('el jugador ' + mensaje.name + ' ha salido de la lobby');
                        alterarLobby(localStorage.getItem('cantidadJugadores'), localStorage.getItem('partidaActiva'), mensaje.gamePlayers);
                    }
                        break;
                    case 'game-ended':
                        console.log(mensaje.message);
                        break;
                    case 'end-tournament':{
                        cargarNuevaSeccion('container-lobby','container-juego',localStorage.getItem('cantidadJugadores'),mensaje.gamePlayers,mensaje.points);
                        console.log(mensaje);
                    }
                        break;
                    case 'playerLeft': {
                        eliminarTablas(mensaje.name);
                        alterarLobby(localStorage.getItem('cantidadJugadores'), localStorage.getItem('partidaActiva'), mensaje.gamePlayers);
                        alert('El jugador ' + mensaje.name + ' ha abandonado la partida.');
                    }
                        break;
                    case 'mina-marina':
                    {
                        let casillaAtacada = mensaje.atacado;
                        let casillaPropia = mensaje.propia;
                        alterarTablero(casillaAtacada,false,mensaje.gamePlayers);
                        alterarTablero(casillaPropia,mensaje.hitPropio,mensaje.gamePlayers);
                        alert ('El jugador '+mensaje.jugadorAtacante+' ataco la mina del jugador '+mensaje.jugadorAtacado);
                        if (!verificarGameOver() )
                        {
                            modificarAnuncio("Ahora es el turno de "+mensaje.gamePlayers[mensaje.turno]);
                            asignarClicks(mensaje.gamePlayers, mensaje.turno);
                        }
                        else
                            location.reload();
                    }
                    break;
                    case 'sonar-answer':
                    {
                        alert ('üó£Ô∏èüî• La ubicaci√≥n de un trozo de barco de '+mensaje.name+' est√° en la posici√≥n '+mensaje.casilla);
                    }
                    break;
                    case 'mina-marina-espectador':
                    {
                        let casillaAtacada = mensaje.atacado;
                        let casillaPropia = mensaje.propia;
                        alterarTablero(casillaAtacada,false,mensaje.gamePlayers);
                        alterarTablero(casillaPropia,mensaje.hitPropio,mensaje.gamePlayers);
                        modificarAnuncio("Ahora es el turno de "+mensaje.gamePlayers[mensaje.turno]);
                        alert ('El jugador '+mensaje.jugadorAtacante+' ataco la mina del jugador '+mensaje.jugadorAtacado);
                    }
                    break;
                    case 'attack': {
                        verificarAtaque(mensaje.casilla,mensaje);
                    }
                    break;
                    case 'attack-mina': {
                        verificarAtaqueMina(mensaje.casilla,mensaje);
                    }
                    break;
                    case 'attack-done':
                        {
                            console.log(mensaje);
                            if (verificarPrevioAtaque(mensaje.casilla)) alterarTablero(mensaje.casilla,mensaje.resultadoAtaque,mensaje.gamePlayers,mensaje.turno);
                            if (!verificarGameOver())
                            {
                                modificarAnuncio("Ahora es el turno de "+mensaje.gamePlayers[mensaje.turno]);
                                asignarClicks(mensaje.gamePlayers, mensaje.turno);
                                verificarPEM();
                                actualizarCooldowns();
                            }
                            else
                                location.reload();
                        }
                        break;
                    case 'attack-done-espectador':
                        {
                            console.log(mensaje);
                            if (verificarPrevioAtaque(mensaje.casilla)) alterarTablero(mensaje.casilla,mensaje.resultadoAtaque,mensaje.gamePlayers);
                                modificarAnuncio("Ahora es el turno de "+mensaje.gamePlayers[mensaje.turno]);
                        }
                        break;
                    case 'player-defeat':
                        {
                            eliminarTablas(mensaje.name);
                            alert('El jugador ' + mensaje.name + ' ha sido derrotado.');
                            recopilarEnemigos();
                            modificarAnuncio("Ahora es el turno de "+mensaje.gamePlayers[mensaje.turno]);
                            asignarClicks(mensaje.gamePlayers, mensaje.turno);
                        }
                        break;
                    case 'victory':
                        {
                            alert ('felicidades, has ganado la partida');
                            location.reload();
                        }
                        break
                    case 'turn-passed':
                        {
                            modificarAnuncio("Ahora es el turno de "+mensaje.gamePlayers[mensaje.turno]);
                            asignarClicks(mensaje.gamePlayers, mensaje.turno);
                        }
                        break;
                    case 'ship-destroyed':
                        {
                            alert('le destruyeron el barco '+mensaje.tipoBarco+' al jugador '+mensaje.name);
                        }
                        break;
                    case 'PEM-attacked':
                        {
                            empDuration+=4;
                            let boton=document.getElementById('compra-potenciador');
                            boton.disabled=true;
                            alert('has sufrido un ataque PEM del jugador: '+mensaje.name+' no podras usar power-Ups durante '+empDuration+' turnos');
                        }
                        break;
                    case 'sonar-active':
                            mandarRespuestaSonar(playerName, mensaje.name);
                        break;
                    default: {
                        alert('Ha ocurrido un error en el servidor.');
                        event.preventDefault();
                    }
                    break;
                }
            }
            catch (error) {
                console.log(error);
                alert('error al parsear el mensaje');
            }
        })

        document.getElementById('creacion-game').addEventListener('click', () => {

            ws.send(JSON.stringify({ type: 'create', playerName: localStorage.getItem('nombreJugador') }))
        })

        let contenedorBoosters = document.getElementById("boosters");
        let boosters = contenedorBoosters.querySelectorAll("li");
        let seleccionado = null;
        boosters.forEach((booster) => 
        {
            booster.addEventListener('click', () => 
            {
                if (seleccionado != booster && seleccionado != null) seleccionado.classList.remove("seleccionado");
                if (seleccionado === booster && seleccionado != null)
                {
                    seleccionado.classList.remove("seleccionado");
                    seleccionado = null;
                }
                else
                {
                    booster.classList.add("seleccionado");
                    seleccionado = booster;
                }
            });
        });

        document.getElementById("compra-potenciador").addEventListener('click', function () 
        {
            if (seleccionado) comprarPowerUp (seleccionado);
        });

        document.getElementById('listo').addEventListener('click', () => {
            ws.send(JSON.stringify({
                type: 'start',
                gameId: localStorage.getItem('partidaActiva'),
                cantidadJugadores: localStorage.getItem('cantidadJugadores')
            }))
        })
        document.getElementById('boton-volver').addEventListener('click', function (event) {
            location.reload();
        })

        document.getElementById('boton-salir').addEventListener('click', function (event) {
            const tablero= document.getElementById(localStorage.getItem('nombreJugador'));
            if (tablero)
            ws.send(JSON.stringify({ type: 'leave-party', gameId: localStorage.getItem('partidaActiva'), playerName: localStorage.getItem('nombreJugador') }));
            else
            ws.send(JSON.stringify({ type: 'leave-tournament', gameId: localStorage.getItem('partidaActiva'), playerName: localStorage.getItem('nombreJugador') }));
            location.reload();
        })
        document.getElementById('boton-salir-lobby').addEventListener('click', function (event) {
            ws.send(JSON.stringify({ type: 'leave-lobby', gameId: localStorage.getItem('partidaActiva'), playerName: localStorage.getItem('nombreJugador') }));
            location.reload();
        })

        document.getElementById('union-game').addEventListener('click', function () {
            let idJuego = prompt("Por favor, ingresa el ID del juego:");
            if (idJuego === null) {
                console.log("Cancelado.");
                return;
            }
            if (idJuego.trim() === "") {
                alert("El ID del juego no puede estar vac√≠o.");
                return;
            }
            console.log("ID del juego ingresado:", idJuego);

            ws.send(JSON.stringify({
                type: 'join',
                playerName: localStorage.getItem('nombreJugador'),
                gameId: idJuego,
                cantidadJugadores: localStorage.getItem('cantidadJugadores')
            }))
        });
    </script>
</body>
</html>